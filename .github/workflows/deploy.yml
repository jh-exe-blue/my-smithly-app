name: ðŸš€ Deploy Avengers Stack

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸš€ Deploy with Docker Compose
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          LITELLM_MASTER_KEY: ${{ secrets.LITELLM_MASTER_KEY }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ë¡œ .env íŒŒì¼ ìƒì„±
          cat > .env << EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          LANGFUSE_PUBLIC_KEY=${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY=${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL=${{ secrets.LANGFUSE_BASE_URL }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}
          LITELLM_MASTER_KEY=${{ secrets.LITELLM_MASTER_KEY }}
          N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}
          EOF
          
          # Docker Composeë¡œ ë°°í¬
          docker-compose -f docker-compose.avengers.yml up -d
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          docker-compose -f docker-compose.avengers.yml ps
      
      - name: âœ… Verify deployment
        run: |
          echo "âœ… Checking services..."
          sleep 30
          docker-compose -f docker-compose.avengers.yml ps
          
      - name: ðŸ“§ Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Deployment failed! Check the logs.'
            })
